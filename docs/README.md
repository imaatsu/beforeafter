# Before/After Sheet Generator

ビフォー・アフター写真をGoogleフォームで収集し、自動的にスライドとPDFを生成してスプレッドシートに書き戻すGoogle Apps Scriptプロジェクトです。

## 概要

このシステムは、改善活動などのビフォー・アフター写真を効率的に管理・共有するためのツールです。Googleフォームからの送信をトリガーに、テンプレートスライドに写真と情報を自動挿入し、PDF化して保存します。

## 機能

- Googleフォームからの自動データ取得
- テンプレートスライドへの写真・テキスト自動挿入
- PDF自動生成
- スプレッドシートへのURL自動書き戻し
- エラーハンドリングとログ機能

## 必要な準備

### 1. Googleスプレッドシート

スプレッドシートには以下の構成が必要です：

#### 必須シート
- **フォームの回答 1** - Googleフォームと連携するシート（デフォルト名）

#### 必須列（フォーム質問タイトルと完全一致させる）
- `ビフォー写真` - ファイルアップロード形式
- `アフター写真` - ファイルアップロード形式
- `実施者` - 記述式
- `改善場所` - 記述式
- `改善日時` - 記述式（任意、未入力時はタイムスタンプを使用）
- `コメント` - 記述式

#### 自動追加列
スクリプト実行時に以下の列が自動追加されます：
- `スライドURL` - 生成されたGoogleスライドのURL
- `PDF URL` - 生成されたPDFファイルのURL
- `エラー` - エラー発生時のメッセージ（エラー時のみ）

### 2. Googleフォーム設定

以下の質問を**完全に同じタイトル**で作成してください：

1. **ビフォー写真**
   - 種類：ファイルのアップロード
   - 設定：画像ファイルのみ許可

2. **アフター写真**
   - 種類：ファイルのアップロード
   - 設定：画像ファイルのみ許可

3. **実施者**
   - 種類：記述式

4. **改善場所**
   - 種類：記述式

5. **改善日時**
   - 種類：記述式
   - 注：任意項目、未入力時はフォーム送信時刻を使用

6. **コメント**
   - 種類：記述式

### 3. Googleスライドテンプレート

テンプレートスライドには以下のマーカーを配置してください：

#### テキストマーカー（テキストボックス内）
- `{{DATE}}` - 日付が挿入されます
- `{{NAME}}` - 実施者名が挿入されます
- `{{PLACE}}` - 改善場所が挿入されます
- `{{COMMENT}}` - コメントが挿入されます

#### 画像マーカー（図形内のテキスト）
- `[[BEFORE_IMG]]` - ビフォー写真が挿入されます
- `[[AFTER_IMG]]` - アフター写真が挿入されます

画像マーカーを含む図形は、画像挿入時に削除され、同じ位置・サイズに画像が配置されます。

### 4. Google Drive フォルダ

生成されたスライドとPDFを保存するためのフォルダを用意してください。

## 設定

`code.gs`の`CONFIG`オブジェクトで以下を設定してください：

```javascript
const CONFIG = {
  // テンプレートスライドのID
  TEMPLATE_ID: 'あなたのスライドIDを入力してください',

  // 出力先フォルダのID
  OUTPUT_FOLDER_ID: 'あなたの環境でのフォルダIDを入力してください',

  // フォーム連携シート名
  SHEET_NAME: 'フォームの回答 1',

  // フォームの質問タイトル（フォーム側と完全一致させる）
  Q: {
    BEFORE: 'ビフォー写真',
    AFTER: 'アフター写真',
    NAME: '実施者',
    PLACE: '改善場所',
    DATE: '改善日時',
    COMMENT: 'コメント'
  }
};
```

### IDの取得方法

#### Googleスライド/DriveフォルダのID
URLから取得：`https://docs.google.com/presentation/d/{ID}/edit`
または `https://drive.google.com/drive/folders/{ID}`

## セットアップ手順

1. **Google Apps Scriptプロジェクトを作成**
   ```bash
   clasp create --type standalone
   ```

2. **コードをデプロイ**
   ```bash
   clasp push
   ```

3. **トリガーを設定**
   - Apps Script エディタで「トリガー」画面を開く
   - 新しいトリガーを追加：
     - 実行する関数：`onFormSubmit`
     - イベントのソース：スプレッドシートから
     - イベントの種類：フォーム送信時

4. **権限を承認**
   - 初回実行時にGoogle Drive、Slides、Sheetsへのアクセス権限を承認

## ファイル構成

```
src/
├── .clasp.json          # CLASP設定ファイル
├── appsscript.json      # Apps Script設定ファイル
└── code.gs              # メインスクリプト
```

## 動作フロー

1. ユーザーがGoogleフォームに写真と情報を入力・送信
2. `onFormSubmit`トリガーが発火
3. フォームデータを取得・解析
4. テンプレートスライドを複製
5. 写真とテキストを自動挿入
6. PDF形式で保存
7. スプレッドシートにスライド・PDFのURLを書き戻し

## エラーハンドリング

- ファイルID取得エラー：フォームのファイルアップロード設定を確認
- マーカー未検出エラー：テンプレートスライドのマーカー配置を確認
- 権限エラー：Apps Scriptの実行権限を確認

エラー発生時は、スプレッドシートの「エラー」列にメッセージが記録されます。

## カスタマイズ

### 質問項目の変更
`CONFIG.Q`の設定を変更し、フォームの質問タイトルと一致させてください。

### マーカーの変更
`CONFIG.MARKER`でテンプレート内のマーカー文字列をカスタマイズできます。

### 出力ファイル名の変更
72行目の`outName`変数で生成されるファイル名をカスタマイズできます。

## 注意事項

- フォームの質問タイトルとCONFIG設定は**完全一致**である必要があります
- ファイルアップロード機能を使用するため、フォーム回答者にはGoogleアカウントが必要です
- 大きな画像ファイルは処理時間が長くなる場合があります
- Apps Scriptの実行時間制限（6分）にご注意ください

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 開発者向け情報

### 主要関数

- `onFormSubmit(e)` - フォーム送信時のメイン処理
- `insertImageAtMarkerBox_()` - 画像の自動配置処理
- `findOrCreateHeaderColumn_()` - スプレッドシート列の動的作成
- `extractDriveFileId_()` - DriveファイルIDの抽出

### デバッグ

Apps Script エディタの実行ログでエラー詳細を確認できます。また、スプレッドシートの「エラー」列にもエラー内容が記録されます。
